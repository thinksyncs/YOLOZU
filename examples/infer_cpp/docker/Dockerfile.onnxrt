FROM ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive
ARG ORT_VERSION=1.24.1
ARG ORT_PLATFORM=linux-x64
ARG ORT_URL=https://github.com/microsoft/onnxruntime/releases/download/v${ORT_VERSION}/onnxruntime-${ORT_PLATFORM}-${ORT_VERSION}.tgz

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    build-essential \
    cmake \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace/YOLOZU
COPY examples/infer_cpp ./examples/infer_cpp

RUN mkdir -p /opt/onnxruntime && \
    curl -L "${ORT_URL}" -o /tmp/onnxruntime.tgz && \
    tar -xzf /tmp/onnxruntime.tgz -C /opt/onnxruntime --strip-components=1 && \
    rm -f /tmp/onnxruntime.tgz

ENV ONNXRUNTIME_ROOT=/opt/onnxruntime
ENV LD_LIBRARY_PATH=/opt/onnxruntime/lib:${LD_LIBRARY_PATH}

RUN cmake -S examples/infer_cpp -B /build \
      -DONNXRUNTIME_ROOT="${ONNXRUNTIME_ROOT}" \
      -DYOLOZU_INFER_BUILD_TRT=OFF && \
    cmake --build /build -j

WORKDIR /build

CMD ["./yolozu_infer_stub", "--help"]

